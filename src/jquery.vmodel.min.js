//1.5
!function(t){t.vmodel={};var r=null,e={};t.vmodel.api=new function(){this.obj_sort=function(r){var e=[],n=0;t.each(r,function(t,r){e[n++]=t}),e.sort();var o={};return t.each(e,function(t,e){o[e]=r[e]}),o},this.each_autoload=function(e,n){t.each(e,function(e,o){"function"!=t.type(n[o])&&r.msg_error(o,"不存在。"),n[o]()})},this.is_trigger_autoload=function(e){if(e.autoload){var n=t.type(e.autoload);if("function"==n){var o=e.autoload();if("array"!=t.type(o))return!1;a=o}else if("array"==n)var a=e.autoload;else r.msg_error("autoload","格式錯誤，型態只能是 function 或 array。");t.vmodel.api.each_autoload(a,e)}}},t.vmodel.end=function(r,e){function n(r,e){var n=[];if("function"==t.type(r)){var o=t.vmodel.get();n=[o,r]}else{var a={};t.each(r,function(r,e){a[e]=t.vmodel.get(e)}),n=[a,e]}return n}var o=n(r,e),a=o[0],i=o[1];r=e=null;var u=setInterval(function(){var r=!0;t.each(a,function(e,n){var o=t.vmodel.history(n.vname);return 0==o?(r=!1,!0):void(r=!0)}),r&&(i(a),clearInterval(u))},0)},t.vmodel.history=function(r){var e=!1,n=t.vmodel.get(r),o=n.root.attr("data-vmodel-history");if(!o)return!1;var a=t.parseJSON(o);return t.each(a,function(t,n){return n.vname!=r?!0:(e=n,!1)}),e},t.vmodel.get=function(r,n,o){function a(r,e,n){var o=[],a=t.type(r);return r?"string"==a&&(o=[r,e,n]):o=[r,null,null],o}var i=this;this.chk_trigger_callback=function(r){var e=!0;return t.each(r.fun_struct,function(t,r){return 0==r?(e=!1,!1):void 0}),0==e?!1:!0},this.display_attr=function(r,e){var n=new Date,o=[{vname:r,status:!0,timestamp:Date.parse(n)+"."+n.getMilliseconds()}],a=e.root.attr("data-vmodel-history");if(a){var i=t.parseJSON(a);i.push(o[0]),o=i}var u=JSON.stringify(o);e.root.attr("data-vmodel-history",u)};var u=a(r,n,o),r=u[0],l=u[1],c=u[2];if(n=o=null,!r)return t.vmodel.api.obj_sort(e);var s=e[r];if(!s)return console.log("呼叫的倉儲名稱 "+r+" 不存在。"),!1;if("boolean"==t.type(l)&&1==l){t.vmodel.api.is_trigger_autoload(s);var f=t.type(c);if("function"==f||"boolean"==f&&1==c){"function"==f&&(s.vmodel_get_callback=function(){c(s)});var v=setInterval(function(){if(1==i.chk_trigger_callback(s)){if(clearInterval(v),i.display_attr(r,s),"boolean"==f)return!0;s.vmodel_get_callback()}},20);return!0}}return e[r]},t.vmodel["delete"]=function(t){return t||""==t?e[t]&&delete e[t]:e={},this},t.fn.vmodel=function(n,o,a){r=this;var i=r.selector;this.remove_sign=function(t){return"--"==t.substring(0,2)?t.substring(2):t},this.msg_error=function(t,r){console.log("發生錯誤。『"+i+"』呼叫的 function 『"+t+"』："+r)},this.def_fun_struct=function(){var r=[],e=t.type(l.autoload);"array"==e?r=l.autoload:"function"==e&&(res=l.autoload(),"array"==t.type(res)&&(r=res)),t.each(r,function(t,r){l.fun_struct[r]=!1})},this.main=function(){return r.def_fun_struct(),o===!0&&t.vmodel.api.is_trigger_autoload(l),l};var u=t.type(n);if("string"==u)if(n=r.remove_sign(n),"boolean"==t.type(o))var l=new a;else var l=new o;else var l=new n;var c="string"==u?n:null;t.extend(l,{vname:c,selector:i,root:t(this),fun_struct:{},struct:function(r,e){if("boolean"==t.type(e)||e||(e=!0),"string"==t.type(r)){if("boolean"!=t.type(l.fun_struct[r]))return console.log("找不到名稱為 "+r+"的建構狀態"),!1;l.fun_struct[r]=e}else{if("array"!=t.type(r))return console.log("建構名稱須要指定"),!1;t.each(r,function(t,r){l.fun_struct[r]=e})}return!0}});var s=this.main();if("string"==t.type(n)){if(e[n])return console.log("倉儲名稱『"+n+"』重複。"),!1;e[n]=s}return this}}(jQuery);